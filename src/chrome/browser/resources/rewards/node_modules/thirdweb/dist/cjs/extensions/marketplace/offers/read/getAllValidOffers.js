"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAllValidOffers = getAllValidOffers;
const eth_getBlockByNumber_js_1 = require("../../../../rpc/actions/eth_getBlockByNumber.js");
const rpc_js_1 = require("../../../../rpc/rpc.js");
const bigint_js_1 = require("../../../../utils/bigint.js");
const getAllValidOffers_js_1 = require("../../__generated__/IOffers/read/getAllValidOffers.js");
const totalOffers_js_1 = require("../../__generated__/IOffers/read/totalOffers.js");
const utils_js_1 = require("../../utils.js");
const utils_js_2 = require("../utils.js");
const DEFAULT_QUERY_ALL_COUNT = 100n;
/**
 * Retrieves all valid offers based on the provided options.
 * @param options - The options for retrieving the valid offers.
 * @returns A promise that resolves to the offers array.
 * @extension MARKETPLACE
 * @example
 *
 * ```ts
 * import { getAllValidOffers } from "thirdweb/extensions/marketplace";
 *
 * const validOffers = await getAllValidOffers({ contract, start: 0, count: 10 });
 * ```
 */
async function getAllValidOffers(options) {
    const totalCount = await (0, totalOffers_js_1.totalOffers)(options);
    // if the totalOffers count is 0, return an empty array and skip all other work
    if (totalCount === 0n) {
        return [];
    }
    const start = BigInt(options.start || 0);
    const count = BigInt(options.count || DEFAULT_QUERY_ALL_COUNT);
    const end = (0, bigint_js_1.min)(totalCount, start + count);
    const rpcClient = (0, rpc_js_1.getRpcClient)(options.contract);
    const [rawOffers, latestBlock] = await Promise.all([
        (0, utils_js_1.getAllInBatches)((startId, endId) => (0, getAllValidOffers_js_1.getAllValidOffers)({
            contract: options.contract,
            startId,
            endId,
        }), {
            start,
            end,
            maxSize: DEFAULT_QUERY_ALL_COUNT,
        }).then((listings) => listings.flat()),
        // get the latest block number once
        (0, eth_getBlockByNumber_js_1.eth_getBlockByNumber)(rpcClient, {
            blockTag: "latest",
        }),
    ]);
    return await Promise.all(rawOffers.map((rawOffer) => (0, utils_js_2.mapOffer)({
        contract: options.contract,
        latestBlock,
        rawOffer,
    })));
}
//# sourceMappingURL=getAllValidOffers.js.map