"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.InAppWalletUI = InAppWalletUI;
exports.OtpLogin = OtpLogin;
exports.PasskeyView = PasskeyView;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_query_1 = require("@tanstack/react-query");
const react_1 = require("react");
const react_native_1 = require("react-native");
const nativeStorage_js_1 = require("../../../../utils/storage/nativeStorage.js");
const index_js_1 = require("../../../../wallets/in-app/native/auth/index.js");
const passkeys_js_1 = require("../../../../wallets/in-app/native/auth/passkeys.js");
const types_js_1 = require("../../../../wallets/types.js");
const storage_js_1 = require("../../../core/utils/storage.js");
const index_js_2 = require("../../design-system/index.js");
const RNImage_js_1 = require("../components/RNImage.js");
const WalletImage_js_1 = require("../components/WalletImage.js");
const button_js_1 = require("../components/button.js");
const input_js_1 = require("../components/input.js");
const spacer_js_1 = require("../components/spacer.js");
const text_js_1 = require("../components/text.js");
const svgs_js_1 = require("../icons/svgs.js");
const LoadingView_js_1 = require("./LoadingView.js");
const defaultAuthOptions = [
    "email",
    "phone",
    "passkey",
    "google",
    "facebook",
    "apple",
];
const socialIcons = {
    google: svgs_js_1.GOOGLE_ICON,
    facebook: svgs_js_1.FACEBOOK_ICON,
    coinbase: svgs_js_1.COINBASE_ICON,
    apple: svgs_js_1.APPLE_ICON,
    discord: svgs_js_1.DISCORD_ICON,
    line: svgs_js_1.LINE_ICON,
    x: svgs_js_1.X_ICON,
    farcaster: svgs_js_1.FARCASTER_ICON,
    telegram: svgs_js_1.TELEGRAM_ICON,
};
function InAppWalletUI(props) {
    const { wallet, theme } = props;
    const config = wallet.getConfig();
    const authOptions = config?.auth?.options || defaultAuthOptions;
    const socialLogins = authOptions.filter((x) => types_js_1.socialAuthOptions.includes(x));
    const [inputMode, setInputMode] = (0, react_1.useState)("email");
    return ((0, jsx_runtime_1.jsxs)(react_native_1.View, { style: styles.container, children: [(0, jsx_runtime_1.jsx)(react_native_1.View, { style: styles.row, children: socialLogins.map((auth) => ((0, jsx_runtime_1.jsx)(SocialLogin, { auth: auth, ...props }, auth))) }), authOptions.includes("email") ? (inputMode === "email" ? ((0, jsx_runtime_1.jsx)(PreOtpLogin, { auth: "email", ...props })) : ((0, jsx_runtime_1.jsx)(button_js_1.ThemedButtonWithIcon, { theme: theme, title: "Email address", icon: (0, WalletImage_js_1.getAuthProviderImage)("email"), onPress: () => setInputMode("email") }))) : null, authOptions.includes("phone") ? (inputMode === "phone" ? ((0, jsx_runtime_1.jsx)(PreOtpLogin, { auth: "phone", ...props })) : ((0, jsx_runtime_1.jsx)(button_js_1.ThemedButtonWithIcon, { theme: theme, title: "Phone number", icon: (0, WalletImage_js_1.getAuthProviderImage)("phone"), onPress: () => setInputMode("phone") }))) : null, authOptions.includes("passkey") ? ((0, jsx_runtime_1.jsx)(button_js_1.ThemedButtonWithIcon, { theme: theme, title: "Passkey", icon: (0, WalletImage_js_1.getAuthProviderImage)("passkey"), onPress: () => {
                    props.setScreen({ screen: "passkey", wallet });
                } })) : null, authOptions.includes("guest") ? (0, jsx_runtime_1.jsx)(GuestLogin, { ...props }) : null] }));
}
function GuestLogin(props) {
    const { theme, wallet, client, connector } = props;
    const connectInAppWallet = (0, react_1.useCallback)(() => {
        connector({
            wallet,
            connectFn: async () => {
                await wallet.connect({
                    client,
                    strategy: "guest",
                });
                await (0, storage_js_1.setLastAuthProvider)("guest", nativeStorage_js_1.nativeLocalStorage);
                return wallet;
            },
            authMethod: "guest",
        });
    }, [connector, wallet, client]);
    return ((0, jsx_runtime_1.jsx)(button_js_1.ThemedButtonWithIcon, { theme: theme, title: "Continue as guest", icon: (0, WalletImage_js_1.getAuthProviderImage)("guest"), onPress: () => {
            connectInAppWallet();
        } }));
}
function SocialLogin(props) {
    const { theme, wallet, auth, client, connector } = props;
    // TODO (rn) - move this onPress and state up
    const strategy = props.auth;
    const connectInAppWallet = (0, react_1.useCallback)(() => {
        connector({
            wallet,
            connectFn: async (chain) => {
                await wallet.connect({
                    client,
                    strategy: auth,
                    chain,
                });
                await (0, storage_js_1.setLastAuthProvider)(auth, nativeStorage_js_1.nativeLocalStorage);
                return wallet;
            },
            authMethod: auth,
        });
    }, [connector, auth, wallet, client]);
    return ((0, jsx_runtime_1.jsx)(react_native_1.TouchableOpacity, { style: [
            styles.socialIconContainer,
            { borderColor: theme.colors.borderColor },
        ], onPress: connectInAppWallet, children: (0, jsx_runtime_1.jsx)(RNImage_js_1.RNImage, { theme: theme, size: 38, data: socialIcons[auth] }) }, strategy));
}
function PreOtpLogin(props) {
    const { theme, auth, client, setScreen, wallet } = props;
    const [phoneOrEmail, setPhoneNumberOrEmail] = (0, react_1.useState)("");
    const sendCode = (0, react_query_1.useMutation)({
        mutationFn: async (options) => {
            const { auth, phoneOrEmail } = options;
            if (auth === "phone") {
                if (phoneOrEmail.slice(0, 1) !== "+") {
                    throw new Error("Invalid phone number. Please include a country code.");
                }
                await (0, index_js_1.preAuthenticate)({
                    client,
                    strategy: auth,
                    phoneNumber: phoneOrEmail,
                });
            }
            else {
                await (0, index_js_1.preAuthenticate)({
                    client,
                    strategy: auth,
                    email: phoneOrEmail,
                });
            }
        },
    });
    return ((0, jsx_runtime_1.jsx)(input_js_1.ThemedInputWithSubmit, { theme: theme, placeholder: auth === "phone" ? "Phone number" : "Email address", onChangeText: setPhoneNumberOrEmail, value: phoneOrEmail, keyboardType: auth === "phone" ? "phone-pad" : "email-address", onSubmit: () => sendCode.mutate({
            auth,
            phoneOrEmail,
        }, {
            onSuccess: (_, vars) => {
                if (vars.auth === "phone") {
                    setScreen({
                        screen: "otp",
                        auth: {
                            strategy: vars.auth,
                            phoneNumber: vars.phoneOrEmail,
                        },
                        wallet,
                    });
                }
                else {
                    setScreen({
                        screen: "otp",
                        auth: { strategy: vars.auth, email: vars.phoneOrEmail },
                        wallet,
                    });
                }
            },
            onError: (error) => {
                // TODO (rn) - handle error toast or input error border/label
                react_native_1.Alert.alert("Error", error.message);
            },
        }), isSubmitting: sendCode.isPending }));
}
function OtpLogin(props) {
    const { theme, auth, wallet, client, connector } = props;
    const [verificationCode, setVerificationCode] = (0, react_1.useState)("");
    const connectInAppWallet = async () => {
        if (!verificationCode || !verificationCode)
            return;
        await connector({
            wallet,
            connectFn: async (chain) => {
                if (auth.strategy === "phone") {
                    await wallet.connect({
                        client,
                        strategy: auth.strategy,
                        phoneNumber: auth.phoneNumber,
                        verificationCode,
                        chain,
                    });
                }
                else {
                    await wallet.connect({
                        client,
                        strategy: auth.strategy,
                        email: auth.email,
                        verificationCode,
                        chain,
                    });
                }
                await (0, storage_js_1.setLastAuthProvider)(auth.strategy, nativeStorage_js_1.nativeLocalStorage);
                return wallet;
            },
            authMethod: auth.strategy,
        });
    };
    return ((0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [(0, jsx_runtime_1.jsxs)(react_native_1.View, { style: {
                    flexDirection: "column",
                    justifyContent: "center",
                    alignItems: "center",
                }, children: [(0, jsx_runtime_1.jsx)(text_js_1.ThemedText, { theme: theme, style: { color: theme.colors.secondaryText }, children: "Enter the verification code sent to" }), (0, jsx_runtime_1.jsx)(text_js_1.ThemedText, { theme: theme, type: "defaultSemiBold", children: auth.strategy === "phone" ? auth.phoneNumber : auth.email })] }), (0, jsx_runtime_1.jsx)(spacer_js_1.Spacer, { size: "xs" }), (0, jsx_runtime_1.jsx)(input_js_1.ThemedInput, { theme: theme, placeholder: "Verification code", onChangeText: setVerificationCode, value: verificationCode, keyboardType: "number-pad" }), (0, jsx_runtime_1.jsx)(button_js_1.ThemedButton, { theme: theme, onPress: connectInAppWallet, variant: "accent", children: (0, jsx_runtime_1.jsx)(text_js_1.ThemedText, { theme: theme, type: "defaultSemiBold", style: { color: theme.colors.accentButtonText }, children: "Verify" }) })] }));
}
function PasskeyView(props) {
    const { theme, wallet, client } = props;
    const [screen, setScreen] = (0, react_1.useState)("loading");
    const triggered = (0, react_1.useRef)(false);
    (0, react_1.useEffect)(() => {
        if (triggered.current) {
            return;
        }
        triggered.current = true;
        (0, passkeys_js_1.hasStoredPasskey)(client)
            .then((isStored) => {
            if (isStored) {
                setScreen("login");
            }
            else {
                setScreen("select");
            }
        })
            .catch(() => {
            setScreen("select");
        });
    }, [client]);
    if (screen === "loading") {
        return (0, jsx_runtime_1.jsx)(LoadingView_js_1.LoadingView, { theme: theme });
    }
    if (screen === "login" || screen === "signup") {
        return ((0, jsx_runtime_1.jsx)(PasskeyLoadingView, { ...props, type: screen === "login" ? "sign-in" : "sign-up" }));
    }
    return (wallet && ((0, jsx_runtime_1.jsxs)(react_native_1.View, { style: {
            flexDirection: "column",
            flex: 1,
            alignItems: "center",
            justifyContent: "center",
            padding: index_js_2.spacing.xl,
        }, children: [(0, jsx_runtime_1.jsx)(RNImage_js_1.RNImage, { theme: theme, size: 90, data: (0, WalletImage_js_1.getAuthProviderImage)("passkey"), color: theme.colors.accentButtonBg }), (0, jsx_runtime_1.jsx)(spacer_js_1.Spacer, { size: "xxl" }), (0, jsx_runtime_1.jsx)(button_js_1.ThemedButton, { theme: theme, variant: "accent", style: { width: "100%" }, onPress: async () => {
                    setScreen("signup");
                }, children: (0, jsx_runtime_1.jsx)(text_js_1.ThemedText, { theme: theme, type: "defaultSemiBold", style: {
                        color: theme.colors.accentButtonText,
                    }, children: "Create a Passkey" }) }), (0, jsx_runtime_1.jsx)(spacer_js_1.Spacer, { size: "md" }), (0, jsx_runtime_1.jsx)(button_js_1.ThemedButton, { theme: theme, variant: "secondary", style: { width: "100%" }, onPress: async () => {
                    setScreen("login");
                }, children: (0, jsx_runtime_1.jsx)(text_js_1.ThemedText, { theme: theme, type: "defaultSemiBold", style: {
                        color: theme.colors.secondaryButtonText,
                    }, children: "I have a Passkey" }) })] })));
}
function PasskeyLoadingView(props) {
    const { theme, type, wallet, client, connector } = props;
    const triggered = (0, react_1.useRef)(false);
    (0, react_1.useEffect)(() => {
        if (triggered.current) {
            return;
        }
        triggered.current = true;
        const connectInAppWallet = async (type) => {
            await connector({
                wallet,
                connectFn: async (chain) => {
                    await wallet.connect({
                        client,
                        strategy: "passkey",
                        type,
                        chain,
                    });
                    await (0, storage_js_1.setLastAuthProvider)("passkey", nativeStorage_js_1.nativeLocalStorage);
                    return wallet;
                },
                authMethod: "passkey",
            });
        };
        connectInAppWallet(type);
    }, [client, type, wallet, connector]);
    return (0, jsx_runtime_1.jsx)(LoadingView_js_1.LoadingView, { theme: theme });
}
const styles = react_native_1.StyleSheet.create({
    container: {
        flexDirection: "column",
        gap: index_js_2.spacing.md,
    },
    row: {
        flexDirection: "row",
        flexWrap: "wrap",
        gap: index_js_2.spacing.md,
        justifyContent: "space-evenly",
    },
    socialIconContainer: {
        flex: 1,
        flexDirection: "column",
        alignItems: "center",
        justifyContent: "center",
        borderStyle: "solid",
        borderWidth: 1,
        borderRadius: index_js_2.radius.lg,
        height: 60,
    },
});
//# sourceMappingURL=InAppWalletUI.js.map