"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getAllValidAuctions = getAllValidAuctions;
const eth_getBlockByNumber_js_1 = require("../../../../rpc/actions/eth_getBlockByNumber.js");
const rpc_js_1 = require("../../../../rpc/rpc.js");
const bigint_js_1 = require("../../../../utils/bigint.js");
const getAllValidAuctions_js_1 = require("../../__generated__/IEnglishAuctions/read/getAllValidAuctions.js");
const totalAuctions_js_1 = require("../../__generated__/IEnglishAuctions/read/totalAuctions.js");
const utils_js_1 = require("../../utils.js");
const utils_js_2 = require("../utils.js");
const DEFAULT_QUERY_ALL_COUNT = 100n;
/**
 * Retrieves all valid auctions based on the provided options.
 * @param options - The options for retrieving the listing.
 * @returns A promise that resolves to the valid auctions array.
 * @extension MARKETPLACE
 * @example
 *
 * ```ts
 * import { getAllValidAuctions } from "thirdweb/extensions/marketplace";
 *
 * const validAuctions = await getAllValidAuctions({ contract, start: 0, count: 10 });
 * ```
 */
async function getAllValidAuctions(options) {
    const totalCount = await (0, totalAuctions_js_1.totalAuctions)(options);
    // if the totalListingCount is 0, return an empty array and skip all other work
    if (totalCount === 0n) {
        return [];
    }
    const start = BigInt(options.start || 0);
    const count = BigInt(options.count || DEFAULT_QUERY_ALL_COUNT);
    const end = (0, bigint_js_1.min)(totalCount, start + count);
    const rpcClient = (0, rpc_js_1.getRpcClient)(options.contract);
    const [rawAuctions, latestBlock] = await Promise.all([
        (0, utils_js_1.getAllInBatches)((startId, endId) => (0, getAllValidAuctions_js_1.getAllValidAuctions)({
            contract: options.contract,
            startId,
            endId,
        }), {
            start,
            end,
            maxSize: DEFAULT_QUERY_ALL_COUNT,
        }).then((listings) => listings.flat()),
        // get the latest block number once
        (0, eth_getBlockByNumber_js_1.eth_getBlockByNumber)(rpcClient, {
            blockTag: "latest",
        }),
    ]);
    const auctions = (await Promise.all(rawAuctions.map((rawAuction) => (0, utils_js_2.mapEnglishAuction)({
        contract: options.contract,
        latestBlock,
        rawAuction,
    })))).filter((auction) => auction !== null);
    return auctions; // TODO: Fix when TS 5.5 is out
}
//# sourceMappingURL=getAllValidAuctions.js.map