"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.deployMarketplaceContract = deployMarketplaceContract;
const viem_1 = require("viem");
const resolve_abi_js_1 = require("../../contract/actions/resolve-abi.js");
const deploy_via_autofactory_js_1 = require("../../contract/deployment/deploy-via-autofactory.js");
const bootstrap_js_1 = require("../../contract/deployment/utils/bootstrap.js");
const upload_js_1 = require("../../storage/upload.js");
const royalty_engine_js_1 = require("../../utils/royalty-engine.js");
const initialize_js_1 = require("./__generated__/Marketplace/write/initialize.js");
/**
 * TODO not quite ready for public consumption yet
 * @internal
 */
async function deployMarketplaceContract(options) {
    const { chain, client, account, params } = options;
    const WETH = await (0, bootstrap_js_1.getOrDeployInfraContract)({
        chain,
        client,
        account,
        contractId: "WETH9",
        constructorParams: [],
    });
    const direct = await (0, bootstrap_js_1.getOrDeployInfraForPublishedContract)({
        chain,
        client,
        account,
        contractId: "DirectListingsLogic",
        constructorParams: [WETH.address],
    });
    const english = await (0, bootstrap_js_1.getOrDeployInfraForPublishedContract)({
        chain,
        client,
        account,
        contractId: "EnglishAuctionsLogic",
        constructorParams: [WETH.address],
    });
    const offers = await (0, bootstrap_js_1.getOrDeployInfraForPublishedContract)({
        chain,
        client,
        account,
        contractId: "OffersLogic",
        constructorParams: [],
    });
    const [directFunctions, englishFunctions, offersFunctions] = await Promise.all([
        (0, resolve_abi_js_1.resolveContractAbi)(direct.implementationContract).then(generateExtensionFunctionsFromAbi),
        (0, resolve_abi_js_1.resolveContractAbi)(english.implementationContract).then(generateExtensionFunctionsFromAbi),
        (0, resolve_abi_js_1.resolveContractAbi)(offers.implementationContract).then(generateExtensionFunctionsFromAbi),
    ]);
    const { cloneFactoryContract, implementationContract } = await (0, bootstrap_js_1.getOrDeployInfraForPublishedContract)({
        chain,
        client,
        account,
        contractId: "MarketplaceV3",
        constructorParams: [
            {
                extensions: [
                    {
                        metadata: {
                            name: "Direct Listings",
                            metadataURI: "",
                            implementation: direct.implementationContract.address,
                        },
                        functions: directFunctions,
                    },
                    {
                        metadata: {
                            name: "English Auctions",
                            metadataURI: "",
                            implementation: english.implementationContract.address,
                        },
                        functions: englishFunctions,
                    },
                    {
                        metadata: {
                            name: "Offers",
                            metadataURI: "",
                            implementation: offers.implementationContract.address,
                        },
                        functions: offersFunctions,
                    },
                ],
                royaltyEngineAddress: (0, royalty_engine_js_1.getRoyaltyEngineV1ByChainId)(chain.id),
                nativeTokenWrapper: WETH.address,
            },
        ],
    });
    const initializeTransaction = await getInitializeTransaction({
        client,
        implementationContract,
        params,
        accountAddress: account.address,
    });
    return (0, deploy_via_autofactory_js_1.deployViaAutoFactory)({
        client,
        chain,
        account,
        cloneFactoryContract,
        initializeTransaction,
    });
}
async function getInitializeTransaction(options) {
    const { client, implementationContract, params, accountAddress } = options;
    const contractURI = options.params.contractURI ||
        (await (0, upload_js_1.upload)({
            client,
            files: [
                {
                    name: params.name,
                    description: params.description,
                    image: params.image,
                    external_link: params.external_link,
                    social_urls: params.social_urls,
                },
            ],
        })) ||
        "";
    return (0, initialize_js_1.initialize)({
        contract: implementationContract,
        contractURI,
        defaultAdmin: params.defaultAdmin || accountAddress,
        platformFeeBps: params.platformFeeBps || 0,
        platformFeeRecipient: params.platformFeeRecipient || accountAddress,
        trustedForwarders: params.trustedForwarders || [],
    });
}
// helperFns
function generateExtensionFunctionsFromAbi(abi) {
    const functions = abi.filter((item) => item.type === "function" && !item.name.startsWith("_"));
    return functions.map((fn) => ({
        functionSelector: (0, viem_1.toFunctionSelector)(fn),
        functionSignature: (0, viem_1.toFunctionSignature)(fn),
    }));
}
//# sourceMappingURL=deploy-marketplace.js.map