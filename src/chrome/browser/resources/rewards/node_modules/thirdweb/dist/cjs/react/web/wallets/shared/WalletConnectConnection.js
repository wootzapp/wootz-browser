"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.WalletConnectStandaloneConnection = exports.WalletConnectConnection = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const wait_js_1 = require("../../../../utils/promise/wait.js");
const url_js_1 = require("../../../../utils/url.js");
const isMobile_js_1 = require("../../../../utils/web/isMobile.js");
const openWindow_js_1 = require("../../../../utils/web/openWindow.js");
const ConnectingScreen_js_1 = require("./ConnectingScreen.js");
const ScanScreen_js_1 = require("./ScanScreen.js");
/**
 * QR Scan UI for connecting a specific wallet on desktop.
 * shows a "Connecting" screen and opens the app on mobile.
 * @internal
 */
const WalletConnectConnection = (props) => {
    const { onBack, onGetStarted, wallet, walletInfo, locale, done } = props;
    const [qrCodeUri, setQrCodeUri] = (0, react_1.useState)();
    const [errorConnecting, setErrorConnecting] = (0, react_1.useState)(false);
    const connect = (0, react_1.useCallback)(() => {
        setErrorConnecting(false);
        wallet
            .connect({
            chain: props.chain,
            client: props.client,
            walletConnect: {
                projectId: props.walletConnect?.projectId,
                showQrModal: false,
                onDisplayUri(uri) {
                    const preferNative = walletInfo.mobile.native || walletInfo.mobile.universal;
                    try {
                        if ((0, isMobile_js_1.isMobile)()) {
                            if ((0, isMobile_js_1.isAndroid)()) {
                                if (preferNative) {
                                    (0, openWindow_js_1.openWindow)((0, url_js_1.formatWalletConnectUrl)(preferNative, uri).redirect);
                                }
                            }
                            else if ((0, isMobile_js_1.isIOS)()) {
                                if (preferNative) {
                                    (0, openWindow_js_1.openWindow)((0, url_js_1.formatWalletConnectUrl)(preferNative, uri).redirect);
                                }
                            }
                            else {
                                const preferUniversal = walletInfo.mobile.universal || walletInfo.mobile.native;
                                if (preferUniversal) {
                                    (0, openWindow_js_1.openWindow)((0, url_js_1.formatWalletConnectUrl)(preferUniversal, uri).redirect);
                                }
                            }
                        }
                        else {
                            setQrCodeUri(uri);
                        }
                    }
                    catch {
                        setErrorConnecting(true);
                    }
                },
                optionalChains: props.chains,
            },
        })
            .then(() => {
            done();
        })
            .catch((e) => {
            setErrorConnecting(true);
            console.error(e);
        });
    }, [
        props.walletConnect,
        walletInfo.mobile.native,
        walletInfo.mobile.universal,
        wallet,
        props.chain,
        props.client,
        props.chains,
        done,
    ]);
    const scanStarted = (0, react_1.useRef)(false);
    (0, react_1.useEffect)(() => {
        if (scanStarted.current) {
            return;
        }
        scanStarted.current = true;
        connect();
    }, [connect]);
    if ((0, isMobile_js_1.isMobile)()) {
        return ((0, jsx_runtime_1.jsx)(ConnectingScreen_js_1.ConnectingScreen, { locale: {
                getStartedLink: locale.getStartedLink,
                instruction: locale.connectionScreen.instruction,
                tryAgain: locale.connectionScreen.retry,
                inProgress: locale.connectionScreen.inProgress,
                failed: locale.connectionScreen.failed,
            }, onBack: onBack, walletName: walletInfo.name, walletId: wallet.id, errorConnecting: errorConnecting, onRetry: connect, onGetStarted: onGetStarted, client: props.client, size: props.size }));
    }
    return ((0, jsx_runtime_1.jsx)(ScanScreen_js_1.ScanScreen, { qrScanInstruction: locale.scanScreen.instruction, onBack: onBack, onGetStarted: onGetStarted, qrCodeUri: qrCodeUri, walletName: walletInfo.name, walletId: wallet.id, getStartedLink: locale.getStartedLink, error: errorConnecting, onRetry: connect, client: props.client, connectModalSize: props.size }));
};
exports.WalletConnectConnection = WalletConnectConnection;
/**
 * QR Scan UI for connecting a specific wallet on desktop.
 * shows a "Connecting" screen and opens the app on mobile.
 * @internal
 */
const WalletConnectStandaloneConnection = (props) => {
    const { onBack, wallet, walletInfo, locale, done, setModalVisibility } = props;
    const [qrCodeUri, setQrCodeUri] = (0, react_1.useState)();
    const [errorConnecting, setErrorConnecting] = (0, react_1.useState)(false);
    const connect = (0, react_1.useCallback)(() => {
        setErrorConnecting(false);
        if ((0, isMobile_js_1.isMobile)()) {
            let wcModalClosed = false;
            // show spinner while the wallet connect modal loads in the background
            (0, wait_js_1.wait)(2000).then(() => {
                // don't hide the modal if wc closed already
                if (!wcModalClosed) {
                    setModalVisibility(false);
                }
            });
            wallet
                .connect({
                chain: props.chain,
                client: props.client,
                projectId: props.walletConnect?.projectId,
                showQrModal: true,
                optionalChains: props.chains,
            })
                .then(() => {
                wcModalClosed = true;
                setModalVisibility(true);
                done();
            })
                .catch((e) => {
                wcModalClosed = true;
                setModalVisibility(true);
                setErrorConnecting(true);
                console.error(e);
            });
        }
        else {
            wallet
                .connect({
                chain: props.chain,
                client: props.client,
                projectId: props.walletConnect?.projectId,
                showQrModal: false,
                onDisplayUri(uri) {
                    const platformUris = {
                        ios: walletInfo.mobile.native || "",
                        android: walletInfo.mobile.universal || "",
                        other: walletInfo.mobile.universal || "",
                    };
                    setQrCodeUri(uri);
                    if ((0, isMobile_js_1.isMobile)()) {
                        if ((0, isMobile_js_1.isAndroid)()) {
                            (0, openWindow_js_1.openWindow)(`${platformUris.android}wc?uri=${encodeURIComponent(uri)}`);
                        }
                        else if ((0, isMobile_js_1.isIOS)()) {
                            (0, openWindow_js_1.openWindow)(`${platformUris.ios}wc?uri=${encodeURIComponent(uri)}`);
                        }
                        else {
                            (0, openWindow_js_1.openWindow)(`${platformUris.other}wc?uri=${encodeURIComponent(uri)}`);
                        }
                    }
                },
                optionalChains: props.chains,
            })
                .then(() => {
                done();
            })
                .catch((e) => {
                setErrorConnecting(true);
                console.error(e);
            });
        }
    }, [
        props.walletConnect,
        walletInfo.mobile.native,
        walletInfo.mobile.universal,
        wallet,
        props.chain,
        props.client,
        props.chains,
        done,
        setModalVisibility,
    ]);
    const scanStarted = (0, react_1.useRef)(false);
    (0, react_1.useEffect)(() => {
        if (scanStarted.current) {
            return;
        }
        scanStarted.current = true;
        connect();
    }, [connect]);
    if ((0, isMobile_js_1.isMobile)()) {
        return ((0, jsx_runtime_1.jsx)(ConnectingScreen_js_1.ConnectingScreen, { locale: {
                getStartedLink: locale.getStartedLink,
                instruction: locale.connectionScreen.instruction,
                tryAgain: locale.connectionScreen.retry,
                inProgress: locale.connectionScreen.inProgress,
                failed: locale.connectionScreen.failed,
            }, onBack: onBack, walletName: walletInfo.name, walletId: wallet.id, errorConnecting: errorConnecting, onRetry: connect, client: props.client, size: props.size }));
    }
    return ((0, jsx_runtime_1.jsx)(ScanScreen_js_1.ScanScreen, { qrScanInstruction: locale.scanScreen.instruction, onBack: onBack, qrCodeUri: qrCodeUri, walletName: walletInfo.name, walletId: wallet.id, getStartedLink: locale.getStartedLink, error: errorConnecting, onRetry: connect, client: props.client, connectModalSize: props.size }));
};
exports.WalletConnectStandaloneConnection = WalletConnectStandaloneConnection;
//# sourceMappingURL=WalletConnectConnection.js.map