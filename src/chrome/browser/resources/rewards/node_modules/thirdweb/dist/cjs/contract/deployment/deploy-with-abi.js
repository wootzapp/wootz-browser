"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.prepareDirectDeployTransaction = prepareDirectDeployTransaction;
exports.deployContract = deployContract;
const send_and_confirm_transaction_js_1 = require("../../transaction/actions/send-and-confirm-transaction.js");
const prepare_transaction_js_1 = require("../../transaction/prepare-transaction.js");
const encodeAbiParameters_js_1 = require("../../utils/abi/encodeAbiParameters.js");
const prefix_js_1 = require("../../utils/bytecode/prefix.js");
const concat_hex_js_1 = require("../../utils/encoding/helpers/concat-hex.js");
const hex_js_1 = require("../../utils/encoding/hex.js");
/**
 * Prepares a direct deploy transaction with ABI.
 * @template TConstructor - The type of the ABI constructor.
 * @param options - The options for preparing the transaction.
 * @returns - The prepared transaction.
 * @example
 * ```ts
 * import { prepareDirectDeployTransaction } from "thirdweb/deploys";
 * import { ethereum } from "thirdweb/chains";
 * const tx = prepareDirectDeployTransaction({
 *  client,
 *  chain: ethereum,
 *  bytecode: "0x...",
 *  constructorAbi: {
 *    inputs: [{ type: "uint256", name: "value" }],
 *    type: "constructor",
 *  },
 *  constructorParams: [123],
 * });
 * ```
 * @extension DEPLOY
 */
function prepareDirectDeployTransaction(options) {
    const bytecode = (0, prefix_js_1.ensureBytecodePrefix)(options.bytecode);
    if (!(0, hex_js_1.isHex)(bytecode)) {
        throw new Error(`Contract bytecode is invalid.\n\n${bytecode}`);
    }
    // prepare the tx
    return (0, prepare_transaction_js_1.prepareTransaction)({
        chain: options.chain,
        client: options.client,
        // the data is the bytecode and the constructor parameters
        data: (0, concat_hex_js_1.concatHex)([
            bytecode,
            (0, encodeAbiParameters_js_1.encodeAbiParameters)(options.constructorAbi.inputs ?? [], // Leave an empty array if there's no constructor
            options.constructorParams),
        ]),
    });
}
/**
 * Deploy a contract on a given chain
 * @param options - the deploy options
 * @returns - a promise that resolves to the deployed contract address
 * @example
 * ```ts
 * import { deployContract } from "thirdweb/deployContract";
 *
 * const address = await deployContract({
 *  client,
 *  chain,
 *  bytecode: "0x...",
 *  constructorAbi: {
 *    inputs: [{ type: "uint256", name: "value" }],
 *    type: "constructor",
 *  },
 *  constructorParams: [123],
 * });
 * ```
 * @extension DEPLOY
 */
async function deployContract(options) {
    const deployTx = prepareDirectDeployTransaction(options);
    const receipt = await (0, send_and_confirm_transaction_js_1.sendAndConfirmTransaction)({
        account: options.account,
        transaction: deployTx,
    });
    if (!receipt.contractAddress) {
        throw new Error(`Could not find deployed contract address in transaction: ${receipt.transactionHash}`);
    }
    return receipt.contractAddress;
}
//# sourceMappingURL=deploy-with-abi.js.map