"use client";
import { jsx as _jsx, Fragment as _Fragment, jsxs as _jsxs } from "react/jsx-runtime";
import styled from "@emotion/styled";
import { useQuery } from "@tanstack/react-query";
import { useMemo, useState } from "react";
import { webLocalStorage } from "../../../../utils/storage/webStorage.js";
import { getEcosystemWalletAuthOptions } from "../../../../wallets/ecosystem/get-ecosystem-wallet-auth-options.js";
import { isEcosystemWallet } from "../../../../wallets/ecosystem/is-ecosystem-wallet.js";
import { linkProfile } from "../../../../wallets/in-app/core/wallet/profiles.js";
import { loginWithOauthRedirect } from "../../../../wallets/in-app/web/lib/auth/oauth.js";
import { socialAuthOptions, } from "../../../../wallets/types.js";
import { useCustomTheme } from "../../../core/design-system/CustomThemeProvider.js";
import { fontSize, iconSize, spacing, } from "../../../core/design-system/index.js";
import { setLastAuthProvider } from "../../../core/utils/storage.js";
import { emailIcon, getWalletIcon, passkeyIcon, phoneIcon, socialIcons, } from "../../../core/utils/walletIcon.js";
import { useSetSelectionData } from "../../providers/wallet-ui-states-provider.js";
import { WalletTypeRowButton } from "../../ui/ConnectWallet/WalletTypeRowButton.js";
import { Img } from "../../ui/components/Img.js";
import { Spacer } from "../../ui/components/Spacer.js";
import { TextDivider } from "../../ui/components/TextDivider.js";
import { Container } from "../../ui/components/basic.js";
import { Button } from "../../ui/components/buttons.js";
import { InputSelectionUI } from "../in-app/InputSelectionUI.js";
import { validateEmail } from "../in-app/validateEmail.js";
import { LoadingScreen } from "./LoadingScreen.js";
import { openOauthSignInWindow } from "./oauthSignIn.js";
const defaultAuthOptions = [
    "email",
    "phone",
    "google",
    "apple",
    "facebook",
    "passkey",
];
/**
 * @internal
 */
export const ConnectWalletSocialOptions = (props) => {
    const locale = props.locale;
    const { wallet } = props;
    const setData = useSetSelectionData();
    const themeObj = useCustomTheme();
    const optionalImageMetadata = useMemo(() => props.wallet.id === "inApp"
        ? props.wallet.getConfig()?.metadata?.image
        : undefined, [props.wallet]);
    const loginMethodsLabel = {
        google: locale.signInWithGoogle,
        facebook: locale.signInWithFacebook,
        apple: locale.signInWithApple,
        discord: locale.signInWithDiscord,
        line: "LINE",
        x: "X",
        coinbase: "Coinbase",
        farcaster: "Farcaster",
        telegram: "Telegram",
    };
    const { data: ecosystemAuthOptions, isLoading } = useQuery({
        queryKey: ["auth-options", wallet.id],
        queryFn: async () => {
            if (isEcosystemWallet(wallet)) {
                return getEcosystemWalletAuthOptions(wallet.id);
            }
            return null;
        },
        enabled: isEcosystemWallet(wallet),
        retry: false,
    });
    const authOptions = isEcosystemWallet(wallet)
        ? (ecosystemAuthOptions ?? defaultAuthOptions)
        : (wallet.getConfig()?.auth?.options ?? defaultAuthOptions);
    const emailIndex = authOptions.indexOf("email");
    const isEmailEnabled = emailIndex !== -1;
    const phoneIndex = authOptions.indexOf("phone");
    const isPhoneEnabled = phoneIndex !== -1;
    const socialLogins = authOptions.filter((o) => socialAuthOptions.includes(o));
    const columnCount = useMemo(() => {
        switch (socialLogins.length) {
            case 7:
                return 4;
            case 6:
                return 4;
            default:
                return 5;
        }
    }, [socialLogins.length]);
    const socialLoginColumns = useMemo(() => {
        return Array.from({ length: Math.ceil(socialLogins.length / columnCount) }, (_, i) => socialLogins.slice(i * columnCount, (i + 1) * columnCount));
    }, [socialLogins, columnCount]);
    const [manualInputMode, setManualInputMode] = useState(null);
    const inputMode = useMemo(() => {
        if (manualInputMode) {
            return manualInputMode;
        }
        if (isEmailEnabled && isPhoneEnabled) {
            return emailIndex < phoneIndex ? "email" : "phone";
        }
        if (isEmailEnabled) {
            return "email";
        }
        if (isPhoneEnabled) {
            return "phone";
        }
        return "none";
    }, [isEmailEnabled, isPhoneEnabled, emailIndex, phoneIndex, manualInputMode]);
    if (isEcosystemWallet(wallet) && isLoading) {
        return _jsx(LoadingScreen, {});
    }
    const passKeyEnabled = authOptions.includes("passkey");
    const guestEnabled = authOptions.includes("guest");
    const placeholder = inputMode === "email" ? locale.emailPlaceholder : locale.phonePlaceholder;
    const emptyErrorMessage = inputMode === "email" ? locale.emailRequired : locale.phoneRequired;
    let type = "text";
    if (inputMode === "email") {
        type = "email";
    }
    else if (inputMode === "phone") {
        type = "tel";
    }
    const hasSocialLogins = socialLogins.length > 0;
    const ecosystemInfo = isEcosystemWallet(wallet)
        ? {
            id: wallet.id,
            partnerId: wallet.getConfig()?.partnerId,
        }
        : undefined;
    const handleGuestLogin = async () => {
        const connectOptions = {
            client: props.client,
            ecosystem: ecosystemInfo,
            strategy: "guest",
        };
        const connectPromise = (async () => {
            const result = await wallet.connect(connectOptions);
            setLastAuthProvider("guest", webLocalStorage);
            return result;
        })();
        setData({
            guestLogin: {
                connectionPromise: connectPromise,
            },
        });
        props.select(); // show Connect UI
    };
    // Need to trigger login on button click to avoid popup from being blocked
    const handleSocialLogin = async (strategy) => {
        const walletConfig = wallet.getConfig();
        const authMode = walletConfig?.auth?.mode ?? "popup";
        if (walletConfig &&
            "auth" in walletConfig &&
            authMode !== "popup" &&
            !props.isLinking // We do not support redirects for linking
        ) {
            return loginWithOauthRedirect({
                authOption: strategy,
                client: props.client,
                ecosystem: ecosystemInfo,
                redirectUrl: walletConfig?.auth?.redirectUrl,
                mode: authMode,
            });
        }
        try {
            const socialLoginWindow = openOauthSignInWindow({
                authOption: strategy,
                themeObj,
                client: props.client,
                ecosystem: ecosystemInfo,
            });
            if (!socialLoginWindow) {
                throw new Error("Failed to open login window");
            }
            const connectOptions = {
                chain: props.chain,
                client: props.client,
                strategy,
                openedWindow: socialLoginWindow,
                closeOpenedWindow: (openedWindow) => {
                    openedWindow.close();
                },
            };
            const connectPromise = (() => {
                if (props.isLinking) {
                    if (wallet.id !== "inApp" && !isEcosystemWallet(wallet)) {
                        throw new Error("Only in-app wallets support multi-auth");
                    }
                    return linkProfile(wallet, connectOptions);
                }
                const connectPromise = wallet.connect(connectOptions);
                setLastAuthProvider(strategy, webLocalStorage);
                return connectPromise;
            })();
            setData({
                socialLogin: {
                    type: strategy,
                    connectionPromise: connectPromise,
                },
            });
            props.select(); // show Connect UI
            // Note: do not call done() here, it will be called SocialLogin component
            // we simply trigger the connect and save promise here - its resolution is handled in SocialLogin
        }
        catch (e) {
            console.error(`Error signing in with ${strategy}`, e);
        }
    };
    function handlePassKeyLogin() {
        setData({
            passkeyLogin: true,
        });
        props.select();
    }
    function handleWalletLogin() {
        setData({
            walletLogin: true,
        });
        props.select();
    }
    const showOnlyIcons = socialLogins.length > 2;
    return (_jsxs(Container, { flex: "column", gap: "md", style: {
            position: "relative",
        }, children: [optionalImageMetadata && (_jsxs(_Fragment, { children: [_jsx(Img, { client: props.client, src: optionalImageMetadata.src, alt: optionalImageMetadata.alt, width: `${optionalImageMetadata.width}`, height: `${optionalImageMetadata.height}`, style: { margin: "auto" } }), _jsx(Spacer, { y: "xxs" })] })), hasSocialLogins && (_jsx(Container, { flex: "column", gap: socialLogins.length > 4 ? "xs" : "sm", children: socialLoginColumns.map((column) => (_jsx(SocialButtonRow, { children: column.map((loginMethod) => {
                        const imgIconSize = (() => {
                            if (!showOnlyIcons) {
                                return iconSize.md;
                            }
                            if (socialLogins.length > 4) {
                                return iconSize.md;
                            }
                            return iconSize.lg;
                        })();
                        return (_jsxs(SocialButton, { "aria-label": `Login with ${loginMethod}`, "data-variant": showOnlyIcons ? "icon" : "full", variant: "outline", disabled: props.disabled, onClick: () => {
                                handleSocialLogin(loginMethod);
                            }, style: {
                                flexGrow: socialLogins.length < 7 ? 1 : 0,
                            }, children: [_jsx(Img, { src: socialIcons[loginMethod], width: imgIconSize, height: imgIconSize, client: props.client }), !showOnlyIcons &&
                                    `${socialLogins.length === 1 ? "Continue with " : ""}${loginMethodsLabel[loginMethod]}`] }, loginMethod));
                    }) }, column[0]))) })), props.size === "wide" &&
                hasSocialLogins &&
                (isEmailEnabled || isPhoneEnabled) && _jsx(TextDivider, { text: locale.or }), isEmailEnabled &&
                (inputMode === "email" ? (_jsx(InputSelectionUI, { type: type, onSelect: (value) => {
                        setData({ emailLogin: value });
                        props.select();
                    }, placeholder: placeholder, name: "email", errorMessage: (input) => {
                        const isValidEmail = validateEmail(input.toLowerCase());
                        if (!isValidEmail) {
                            return locale.invalidEmail;
                        }
                        return undefined;
                    }, disabled: props.disabled, emptyErrorMessage: emptyErrorMessage, submitButtonText: locale.submitEmail })) : (_jsx(WalletTypeRowButton, { client: props.client, icon: emailIcon, onClick: () => {
                        setManualInputMode("email");
                    }, title: locale.emailPlaceholder, disabled: props.disabled }))), isPhoneEnabled &&
                (inputMode === "phone" ? (_jsx(InputSelectionUI, { format: "phone", type: type, onSelect: (value) => {
                        // removes white spaces and special characters
                        setData({ phoneLogin: value.replace(/[-\(\) ]/g, "") });
                        props.select();
                    }, placeholder: placeholder, name: "phone", errorMessage: (_input) => {
                        // removes white spaces and special characters
                        const input = _input.replace(/[-\(\) ]/g, "");
                        const isPhone = /^[0-9]+$/.test(input);
                        if (!isPhone && isPhoneEnabled) {
                            return locale.invalidPhone;
                        }
                        return undefined;
                    }, disabled: props.disabled, emptyErrorMessage: emptyErrorMessage, submitButtonText: locale.submitEmail })) : (_jsx(WalletTypeRowButton, { client: props.client, icon: phoneIcon, onClick: () => {
                        setManualInputMode("phone");
                    }, title: locale.phonePlaceholder, disabled: props.disabled }))), passKeyEnabled && (_jsx(WalletTypeRowButton, { client: props.client, icon: passkeyIcon, onClick: () => {
                    handlePassKeyLogin();
                }, title: locale.passkey, disabled: props.disabled })), guestEnabled && (_jsx(WalletTypeRowButton, { client: props.client, icon: getWalletIcon("guest"), onClick: () => {
                    handleGuestLogin();
                }, title: locale.loginAsGuest, disabled: props.disabled })), props.isLinking && (_jsx(WalletTypeRowButton, { client: props.client, icon: getWalletIcon(""), onClick: () => {
                    handleWalletLogin();
                }, title: locale.linkWallet }))] }));
};
const SocialButtonRow = (props) => (_jsx(Container, { flex: "row", center: "x", gap: props.children.length > 4 ? "xs" : "sm", style: {
        justifyContent: "center",
        display: "flex",
        ...{
            "& > *": {
                flexBasis: `${100 / props.children.length}%`,
                maxWidth: `${100 / props.children.length}%`,
            },
        },
    }, children: props.children }));
const SocialButton = /* @__PURE__ */ styled(Button)({
    "&[data-variant='full']": {
        display: "flex",
        justifyContent: "flex-start",
        padding: spacing.md,
        gap: spacing.sm,
        fontSize: fontSize.md,
        fontWeight: 500,
        transition: "background-color 0.2s ease",
        "&:active": {
            boxShadow: "none",
        },
    },
    "&[data-variant='icon']": {
        padding: spacing.sm,
    },
});
//# sourceMappingURL=ConnectWalletSocialOptions.js.map