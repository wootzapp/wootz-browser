{"version":3,"file":"model-viewer-base-spec.js","sourceRoot":"","sources":["../../src/test/model-viewer-base-spec.ts"],"names":[],"mappings":"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","sourcesContent":["/* @license\n * Copyright 2019 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {$renderer, $scene, $userInputElement} from '../model-viewer-base.js';\nimport {ModelViewerElement} from '../model-viewer.js';\nimport {Renderer} from '../three-components/Renderer.js';\nimport {timePasses, waitForEvent} from '../utilities.js';\n\nimport {assetPath, spy, until} from './helpers.js';\n\nconst expect = chai.expect;\n\nconst expectBlobDimensions =\n    async (blob: Blob, width: number, height: number) => {\n  const img = await new Promise<HTMLImageElement>((resolve) => {\n    const url = URL.createObjectURL(blob);\n    const img = new Image();\n    img.onload = () => {\n      resolve(img);\n    };\n    img.src = url;\n  });\n\n  expect(img.width).to.be.equal(Math.round(width));\n  expect(img.height).to.be.equal(Math.round(height));\n};\n\nsuite('ModelViewerElementBase', () => {\n  suite('with an element', () => {\n    let element: ModelViewerElement;\n    let input: HTMLDivElement;\n\n    setup(() => {\n      element = new ModelViewerElement();\n      input = element[$userInputElement];\n      document.body.insertBefore(element, document.body.firstChild);\n    });\n\n    teardown(() => {\n      if (element.parentNode != null) {\n        element.parentNode.removeChild(element);\n      }\n    });\n\n    suite('with alt text', () => {\n      test('gives the input a related aria-label', async () => {\n        const altText = 'foo';\n        element.alt = altText;\n        await timePasses();\n        expect(input.getAttribute('aria-label')).to.be.equal(altText);\n      });\n\n      suite('that is removed', () => {\n        test('reverts input to default aria-label', async () => {\n          const defaultAriaLabel = input.getAttribute('aria-label');\n          const altText = 'foo';\n\n          element.alt = altText;\n          await timePasses();\n          element.alt = null;\n          await timePasses();\n\n          expect(input.getAttribute('aria-label'))\n              .to.be.equal(defaultAriaLabel);\n        });\n      });\n    });\n\n    suite('with a valid src', () => {\n      test('eventually dispatches a load event', async () => {\n        const sourceLoads = waitForEvent(element, 'load');\n        element.src = assetPath('models/Astronaut.glb');\n        await sourceLoads;\n      });\n\n      suite('that changes before the model loads', () => {\n        test('it loads the second value on microtask timing', async () => {\n          element.src = assetPath('models/Astronaut.glb');\n          await timePasses();\n          element.src = assetPath('models/Horse.glb');\n          await waitForEvent(element, 'load');\n\n          expect(element[$scene].url)\n              .to.be.equal(assetPath('models/Horse.glb'));\n        });\n\n        test('it loads the second value on task timing', async () => {\n          element.src = assetPath('models/Astronaut.glb');\n          await timePasses(1);\n          element.src = assetPath('models/Horse.glb');\n          await waitForEvent(element, 'load');\n\n          expect(element[$scene].url)\n              .to.be.equal(assetPath('models/Horse.glb'));\n        });\n      });\n    });\n\n    test('with an invalid src, dispatches an error event', async () => {\n      const sourceErrors = waitForEvent(element, 'error');\n      element.src = './does-not-exist.glb';\n      const event = await sourceErrors;\n\n      expect((event as any).detail.type).to.be.eq('loadfailure');\n    });\n\n    test('when losing the GL context, dispatches an error event', async () => {\n      const {threeRenderer, canvas3D} = Renderer.singleton;\n\n      canvas3D.addEventListener('webglcontextlost', function(event) {\n        event.preventDefault();\n        Renderer.resetSingleton();\n      }, false);\n\n      const errorEventDispatches = waitForEvent(element, 'error');\n      // We make a best effort to simulate the real scenario here, but\n      // for some cases like headless Chrome WebGL might be disabled,\n      // so we simulate the scenario.\n      // @see https://threejs.org/docs/index.html#api/en/renderers/WebGLRenderer.forceContextLoss\n      if (threeRenderer.getContext() != null) {\n        threeRenderer.forceContextLoss();\n      } else {\n        threeRenderer.domElement.dispatchEvent(\n            new CustomEvent('webglcontextlost'));\n      }\n      const event = await errorEventDispatches;\n      expect((event as any).detail.type).to.be.equal('webglcontextlost');\n    });\n\n    suite('capturing screenshots', () => {\n      let width: number;\n      let height: number;\n      setup(async () => {\n        // Avoid testing our memory ceiling in CI by limiting the size\n        // of the screenshots we produce in these tests:\n        width = 32;\n        height = 64;\n        element.style.width = `${width}px`;\n        element.style.height = `${height}px`;\n\n        const modelLoads = waitForEvent(element, 'load');\n        element.src = assetPath('models/cube.gltf');\n        await modelLoads;\n      });\n\n      suite('toDataURL', () => {\n        test('produces a URL-compatible string', () => {\n          const dataUrlMatcher = /^data\\:image\\//;\n          expect(dataUrlMatcher.test(element.toDataURL())).to.be.true;\n        });\n      });\n\n      suite('toBlob', () => {\n        test('produces a blob', async () => {\n          const blob = await element.toBlob();\n          expect(blob).to.not.be.null;\n        });\n\n        test('can convert blob to object URL', async () => {\n          const blob = await element.toBlob();\n          const objectUrl = URL.createObjectURL(blob);\n          const objectUrlMatcher = /^blob\\:/;\n          expect(objectUrlMatcher.test(objectUrl)).to.be.true;\n        });\n\n        test('has size', async () => {\n          const blob = await element.toBlob();\n          expect(blob.size).to.be.greaterThan(0);\n        });\n\n        test('uses fallbacks on unsupported browsers', async () => {\n          // Emulate unsupported browser\n          let restoreCanvasToBlob = () => {};\n          try {\n            restoreCanvasToBlob =\n                spy(HTMLCanvasElement.prototype, 'toBlob', {value: undefined});\n          } catch (error) {\n            // Ignored...\n          }\n\n          const blob = await element.toBlob();\n          expect(blob).to.not.be.null;\n\n          restoreCanvasToBlob();\n        });\n\n        test(\n            'blobs on supported and unsupported browsers are equivalent',\n            async () => {\n              let restoreCanvasToBlob = () => {};\n              try {\n                restoreCanvasToBlob = spy(\n                    HTMLCanvasElement.prototype, 'toBlob', {value: undefined});\n              } catch (error) {\n                // Ignored...\n              }\n\n              const unsupportedBrowserBlob = await element.toBlob();\n\n              restoreCanvasToBlob();\n\n              const supportedBrowserBlob = await element.toBlob();\n\n              // Blob.prototype.arrayBuffer is not available in Edge / Safari\n              // Using Response to get arrayBuffer instead\n              const supportedBrowserResponse =\n                  new Response(supportedBrowserBlob);\n              const unsupportedBrowserResponse =\n                  new Response(unsupportedBrowserBlob);\n\n              const supportedBrowserArrayBuffer =\n                  await supportedBrowserResponse.arrayBuffer();\n              const unsupportedBrowserArrayBuffer =\n                  await unsupportedBrowserResponse.arrayBuffer();\n\n              expect(unsupportedBrowserArrayBuffer)\n                  .to.eql(supportedBrowserArrayBuffer);\n            });\n\n        test.skip('idealAspect gives the proper blob dimensions', async () => {\n          const basicBlob = await element.toBlob();\n          const idealBlob = await element.toBlob({idealAspect: true});\n          const idealHeight = 32 / element[$scene].idealAspect;\n\n          const {dpr, scaleFactor} = element[$renderer];\n          const f = dpr * scaleFactor;\n          await expectBlobDimensions(basicBlob, width * f, height * f);\n          await expectBlobDimensions(idealBlob, width * f, idealHeight * f);\n        });\n      });\n    });\n  });\n\n  suite('orchestrates rendering', () => {\n    let elements: Array<ModelViewerElement> = [];\n\n    setup(async () => {\n      elements.push(new ModelViewerElement());\n      elements.push(new ModelViewerElement());\n      elements.push(new ModelViewerElement());\n\n      for (let element of elements) {\n        element.style.position = 'relative';\n        element.style.marginBottom = '100vh';\n        element.src = assetPath('models/cube.gltf');\n        document.body.insertBefore(element, document.body.firstChild);\n      }\n    });\n\n    teardown(() => {\n      elements.forEach(\n          element => element.parentNode != null &&\n              element.parentNode.removeChild(element));\n    });\n\n    test('sets a model within viewport to be visible', async () => {\n      await until(() => {\n        return elements[2].modelIsVisible;\n      });\n\n      expect(elements[2].modelIsVisible).to.be.true;\n    });\n\n    test.skip('only models visible in the viewport', async () => {\n      // IntersectionObserver needs to set appropriate\n      // visibility on the scene, lots of timing issues when\n      // running -- wait for the visibility flags to be flipped\n      await until(() => {\n        return elements\n            .map((element, index) => {\n              return (index === 0) === element.modelIsVisible;\n            })\n            .reduce(((l, r) => l && r), true);\n      });\n\n      expect(elements[0].modelIsVisible).to.be.ok;\n      expect(elements[1].modelIsVisible).to.not.be.ok;\n      expect(elements[2].modelIsVisible).to.not.be.ok;\n    });\n  });\n});\n"]}