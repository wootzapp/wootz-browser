{"version":3,"file":"ar-spec.js","sourceRoot":"","sources":["../../../src/test/features/ar-spec.ts"],"names":[],"mappings":"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","sourcesContent":["/* @license\n * Copyright 2019 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {IS_ANDROID, IS_IOS} from '../../constants.js';\nimport {$openIOSARQuickLook, $openSceneViewer} from '../../features/ar.js';\nimport {ModelViewerElement} from '../../model-viewer.js';\nimport {waitForEvent} from '../../utilities.js';\nimport {assetPath, rafPasses, spy} from '../helpers.js';\n\nconst expect = chai.expect;\n\nsuite('AR', () => {\n  let element: ModelViewerElement;\n  let intentUrls: Array<string>;\n  let restoreAnchorClick: () => void;\n\n  setup(() => {\n    element = new ModelViewerElement();\n    document.body.insertBefore(element, document.body.firstChild);\n    intentUrls = [];\n    restoreAnchorClick = spy(HTMLAnchorElement.prototype, 'click', {\n      value: function() {\n        intentUrls.push((this as HTMLAnchorElement).href);\n      }\n    });\n  });\n\n  teardown(() => {\n    if (element.parentNode != null) {\n      element.parentNode.removeChild(element);\n    }\n    restoreAnchorClick();\n  });\n\n  suite('openSceneViewer', () => {\n    test('preserves query parameters in model URLs', () => {\n      element.src = 'https://example.com/model.gltf?token=foo';\n      element.alt = 'Example model';\n      (element as any)[$openSceneViewer]();\n\n      expect(intentUrls.length).to.be.equal(1);\n\n      const search = new URLSearchParams(new URL(intentUrls[0]).search);\n\n      expect(search.get('token')).to.equal('foo');\n    });\n\n    test('keeps title and link when supplied', () => {\n      element.src =\n          'https://example.com/model.gltf?link=http://linkme.com&title=bar';\n      element.alt = 'alt';\n      (element as any)[$openSceneViewer]();\n\n      expect(intentUrls.length).to.be.equal(1);\n\n      const search = new URLSearchParams(new URL(intentUrls[0]).search);\n\n      expect(search.get('title')).to.equal('bar');\n      expect(search.get('link')).to.equal('http://linkme.com/');\n    });\n\n    test('sets sound and link to absolute URLs', () => {\n      element.src =\n          'https://example.com/model.gltf?link=foo.html&sound=bar.ogg';\n      element.alt = 'alt';\n      (element as any)[$openSceneViewer]();\n\n      expect(intentUrls.length).to.be.equal(1);\n\n      const search = new URLSearchParams(new URL(intentUrls[0]).search);\n\n      // Tests run in different locations\n      expect(search.get('sound')).to.contain('http://');\n      expect(search.get('sound')).to.contain('/bar.ogg');\n      expect(search.get('link')).to.contain('http://');\n      expect(search.get('link')).to.contain('/foo.html');\n    });\n  });\n\n  suite('openQuickLook', () => {\n    test('sets hash for fixed scale', () => {\n      element.src = 'https://example.com/model.gltf';\n      element.iosSrc = 'https://example.com/model.usdz';\n      element.arScale = 'fixed';\n      (element as any)[$openIOSARQuickLook]();\n\n      expect(intentUrls.length).to.be.equal(1);\n\n      const url = new URL(intentUrls[0]);\n\n      expect(url.pathname).equal('/model.usdz');\n      expect(url.hash).to.equal('#allowsContentScaling=0');\n    });\n\n    test('keeps original hash too', () => {\n      element.src = 'https://example.com/model.gltf';\n      element.iosSrc =\n          'https://example.com/model.usdz#custom=path-to-banner.html';\n      element.arScale = 'fixed';\n      (element as any)[$openIOSARQuickLook]();\n\n      expect(intentUrls.length).to.be.equal(1);\n\n      const url = new URL(intentUrls[0]);\n\n      expect(url.pathname).equal('/model.usdz');\n      expect(url.hash).to.equal(\n          '#custom=path-to-banner.html&allowsContentScaling=0');\n    });\n\n    test('replicate src hash to usdz blob url', async () => {\n      element.src =\n          assetPath('models/cube.gltf') + '#custom=path-to-banner.html';\n      element.arModes = 'webxr scene-viewer quick-look';\n\n      await (element as any)[$openIOSARQuickLook]();\n\n      expect(intentUrls.length).to.be.equal(1);\n\n      const url = new URL(intentUrls[0]);\n\n      expect(url.protocol).to.equal('blob:');\n\n      expect(url.hash).to.equal('#custom=path-to-banner.html');\n    });\n\n    test(\n        'replicate src hash to usdz blob and set hash for fixed scale',\n        async () => {\n          element.src =\n              assetPath('models/cube.gltf') + '#custom=path-to-banner.html';\n          element.arModes = 'webxr scene-viewer quick-look';\n          element.arScale = 'fixed';\n\n          await (element as any)[$openIOSARQuickLook]();\n\n          expect(intentUrls.length).to.be.equal(1);\n\n          const url = new URL(intentUrls[0]);\n\n          expect(url.protocol).to.equal('blob:');\n\n          expect(url.hash).to.equal(\n              '#custom=path-to-banner.html&allowsContentScaling=0');\n        });\n  });\n\n  suite('shows the AR button', () => {\n    setup(async () => {\n      element.ar = true;\n      element.src = assetPath('models/Astronaut.glb');\n\n      await waitForEvent(element, 'poster-dismissed');\n    });\n\n    // This fails on Android when karma.conf has hostname: 'bs-local.com',\n    // possibly due to not serving over HTTPS (which disables WebXR)? However,\n    // Browserstack is unstable without this hostname.\n    test('if on a WebXR platform', () => {\n      expect(element.canActivateAR).to.be.equal(IS_ANDROID || IS_IOS);\n    });\n\n    test('with an ios-src on iOS', async () => {\n      element.iosSrc = assetPath('models/Astronaut.usdz');\n      await rafPasses();\n      expect(element.canActivateAR).to.be.equal(IS_ANDROID || IS_IOS);\n    });\n  });\n});\n"]}