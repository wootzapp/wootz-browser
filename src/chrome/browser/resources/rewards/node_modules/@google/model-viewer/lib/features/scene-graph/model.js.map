{"version":3,"file":"model.js","sourceRoot":"","sources":["../../../src/features/scene-graph/model.ts"],"names":[],"mappings":"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","sourcesContent":["/* @license\n * Copyright 2020 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Group, Intersection, Material as ThreeMaterial, Mesh, MeshStandardMaterial, Object3D, Raycaster} from 'three';\n\nimport {CorrelatedSceneGraph, GLTFElementToThreeObjectMap, ThreeObjectSet} from '../../three-components/gltf-instance/correlated-scene-graph.js';\nimport {GLTF, GLTFElement, Material as GLTFMaterial} from '../../three-components/gltf-instance/gltf-2.0.js';\n\nimport {Model as ModelInterface} from './api.js';\nimport {$setActive, $variantSet, Material} from './material.js';\nimport {$children, Node, PrimitiveNode} from './nodes/primitive-node.js';\nimport {$correlatedObjects, $sourceObject} from './three-dom-element.js';\n\n\n\nexport const $materials = Symbol('materials');\nconst $hierarchy = Symbol('hierarchy');\nconst $roots = Symbol('roots');\nexport const $primitivesList = Symbol('primitives');\nexport const $loadVariant = Symbol('loadVariant');\nexport const $correlatedSceneGraph = Symbol('correlatedSceneGraph');\nexport const $prepareVariantsForExport = Symbol('prepareVariantsForExport');\nexport const $switchVariant = Symbol('switchVariant');\nexport const $threeScene = Symbol('threeScene');\nexport const $materialsFromPoint = Symbol('materialsFromPoint');\nexport const $materialFromPoint = Symbol('materialFromPoint');\nexport const $variantData = Symbol('variantData');\nexport const $availableVariants = Symbol('availableVariants');\nconst $modelOnUpdate = Symbol('modelOnUpdate');\nconst $cloneMaterial = Symbol('cloneMaterial');\n\n// Holds onto temporary scene context information needed to perform lazy loading\n// of a resource.\nexport class LazyLoader {\n  gltf: GLTF;\n  gltfElementMap: GLTFElementToThreeObjectMap;\n  mapKey: GLTFElement;\n  doLazyLoad: () => Promise<{set: ThreeObjectSet, material: ThreeMaterial}>;\n  constructor(\n      gltf: GLTF, gltfElementMap: GLTFElementToThreeObjectMap,\n      mapKey: GLTFElement,\n      doLazyLoad:\n          () => Promise<{set: ThreeObjectSet, material: ThreeMaterial}>) {\n    this.gltf = gltf;\n    this.gltfElementMap = gltfElementMap;\n    this.mapKey = mapKey;\n    this.doLazyLoad = doLazyLoad;\n  }\n}\n\n/**\n * Facades variant mapping data.\n */\nexport interface VariantData {\n  name: string;\n  index: number;\n}\n\n/**\n * A Model facades the top-level GLTF object returned by Three.js' GLTFLoader.\n * Currently, the model only bothers itself with the materials in the Three.js\n * scene graph.\n */\nexport class Model implements ModelInterface {\n  private[$materials] = new Array<Material>();\n  private[$hierarchy] = new Array<Node>();\n  private[$roots] = new Array<Node>();\n  private[$primitivesList] = new Array<PrimitiveNode>();\n  private[$threeScene]: Object3D|Group;\n  private[$modelOnUpdate]: () => void = () => {};\n  private[$correlatedSceneGraph]: CorrelatedSceneGraph;\n  private[$variantData] = new Map<string, VariantData>();\n\n  constructor(\n      correlatedSceneGraph: CorrelatedSceneGraph,\n      onUpdate: () => void = () => {}) {\n    this[$modelOnUpdate] = onUpdate;\n    this[$correlatedSceneGraph] = correlatedSceneGraph;\n    const {gltf, threeGLTF, gltfElementMap} = correlatedSceneGraph;\n    this[$threeScene] = threeGLTF.scene;\n\n    for (const [i, material] of gltf.materials!.entries()) {\n      const correlatedMaterial =\n          gltfElementMap.get(material) as Set<MeshStandardMaterial>;\n\n      if (correlatedMaterial != null) {\n        this[$materials].push(new Material(\n            onUpdate,\n            gltf,\n            material,\n            i,\n            true,\n            this[$variantData],\n            correlatedMaterial));\n      } else {\n        const elementArray = gltf['materials'] || [];\n        const gltfMaterialDef = elementArray[i];\n\n        // Loads the three.js material.\n        const capturedMatIndex = i;\n        const materialLoadCallback = async () => {\n          const threeMaterial =\n              await threeGLTF.parser.getDependency(\n                  'material', capturedMatIndex) as MeshStandardMaterial;\n\n          // Adds correlation, maps the variant gltf-def to the\n          // three material set containing the variant material.\n          const threeMaterialSet = new Set<MeshStandardMaterial>();\n          gltfElementMap.set(gltfMaterialDef, threeMaterialSet);\n          threeMaterialSet.add(threeMaterial);\n\n          return {set: threeMaterialSet, material: threeMaterial};\n        };\n\n        // Configures the material for lazy loading.\n        this[$materials].push(new Material(\n            onUpdate,\n            gltf,\n            gltfMaterialDef,\n            i,\n            false,\n            this[$variantData],\n            correlatedMaterial,\n            new LazyLoader(\n                gltf, gltfElementMap, gltfMaterialDef, materialLoadCallback)));\n      }\n    }\n\n    // Creates a hierarchy of Nodes. Allows not just for switching which\n    // material is applied to a mesh but also exposes a way to provide API\n    // for switching materials and general assignment/modification.\n\n    // Prepares for scene iteration.\n    const parentMap = new Map<object, Node>();\n    const nodeStack = new Array<Object3D>();\n    for (const object of threeGLTF.scene.children) {\n      nodeStack.push(object);\n    }\n\n    // Walks the hierarchy and creates a node tree.\n    while (nodeStack.length > 0) {\n      const object = nodeStack.pop()!;\n\n      let node: Node|null = null;\n\n      if (object instanceof Mesh) {\n        node = new PrimitiveNode(\n            object as Mesh,\n            this.materials,\n            this[$variantData],\n            correlatedSceneGraph);\n        this[$primitivesList].push(node as PrimitiveNode);\n      } else {\n        node = new Node(object.name);\n      }\n\n      const parent: Node|undefined = parentMap.get(object);\n      if (parent != null) {\n        parent[$children].push(node);\n      } else {\n        this[$roots].push(node);\n      }\n      this[$hierarchy].push(node);\n\n      for (const child of object.children) {\n        nodeStack.push(child);\n        parentMap.set(object, node);\n      }\n    }\n  }\n\n  /**\n   * Materials are listed in the order of the GLTF materials array, plus a\n   * default material at the end if one is used.\n   *\n   * TODO(#1003): How do we handle non-active scenes?\n   */\n  get materials(): Material[] {\n    return this[$materials];\n  }\n\n  [$availableVariants]() {\n    const variants = Array.from(this[$variantData].values());\n    variants.sort((a, b) => {\n      return a.index - b.index;\n    });\n\n    return variants.map((data) => {\n      return data.name;\n    });\n  }\n\n  getMaterialByName(name: string): Material|null {\n    const matches = this[$materials].filter(material => {\n      return material.name === name;\n    });\n\n    if (matches.length > 0) {\n      return matches[0];\n    }\n    return null;\n  }\n\n\n  /**\n   * Intersects a ray with the Model and returns a list of materials whose\n   * objects were intersected.\n   */\n  [$materialsFromPoint](raycaster: Raycaster): Material[] {\n    const hits = raycaster.intersectObject(this[$threeScene], true);\n\n    // Map the object hits to primitives and then to the active material of\n    // the primitive.\n    return hits.map((hit: Intersection<Object3D>) => {\n      const found = this[$hierarchy].find((node: Node) => {\n        if (node instanceof PrimitiveNode) {\n          const primitive = node as PrimitiveNode;\n          if (primitive.mesh === hit.object) {\n            return true;\n          }\n        }\n        return false;\n      }) as PrimitiveNode;\n\n      if (found != null) {\n        return found.getActiveMaterial();\n      }\n      return null;\n    }) as Material[];\n  }\n\n  /**\n   * Intersects a ray with the Model and returns the first material whose\n   * object was intersected.\n   */\n  [$materialFromPoint](raycaster: Raycaster): Material|null {\n    const materials = this[$materialsFromPoint](raycaster);\n\n    if (materials.length > 0) {\n      return materials[0];\n    }\n\n    return null;\n  }\n\n  /**\n   * Switches model variant to the variant name provided, or switches to\n   * default/initial materials if 'null' is provided.\n   */\n  async[$switchVariant](variantName: string|null) {\n    for (const primitive of this[$primitivesList]) {\n      await primitive.enableVariant(variantName);\n    }\n\n    for (const material of this.materials) {\n      material[$setActive](false);\n    }\n    // Marks the materials that are now in use after the variant switch.\n    for (const primitive of this[$primitivesList]) {\n      this.materials[primitive.getActiveMaterial().index][$setActive](true);\n    }\n  }\n\n  async[$prepareVariantsForExport]() {\n    const promises = new Array<Promise<void>>();\n    for (const primitive of this[$primitivesList]) {\n      promises.push(primitive.instantiateVariants());\n    }\n    await Promise.all(promises);\n  }\n\n  [$cloneMaterial](index: number, newMaterialName: string): Material {\n    const material = this.materials[index];\n\n    if (!material.isLoaded) {\n      console.error(`Cloning an unloaded material,\n           call 'material.ensureLoaded() before cloning the material.`);\n    }\n\n    const threeMaterialSet =\n        material[$correlatedObjects] as Set<MeshStandardMaterial>;\n\n    // clones the gltf material data and updates the material name.\n    const gltfSourceMaterial =\n        JSON.parse(JSON.stringify(material[$sourceObject])) as GLTFMaterial;\n    gltfSourceMaterial.name = newMaterialName;\n    // Adds the source material clone to the gltf def.\n    const gltf = this[$correlatedSceneGraph].gltf;\n    gltf.materials!.push(gltfSourceMaterial);\n\n    const clonedSet = new Set<MeshStandardMaterial>();\n    for (const [i, threeMaterial] of threeMaterialSet.entries()) {\n      const clone = threeMaterial.clone() as MeshStandardMaterial;\n      clone.name =\n          newMaterialName + (threeMaterialSet.size > 1 ? '_inst' + i : '');\n      clonedSet.add(clone);\n    }\n\n    const clonedMaterial = new Material(\n        this[$modelOnUpdate],\n        this[$correlatedSceneGraph].gltf,\n        gltfSourceMaterial,\n        this[$materials].length,\n        false,  // Cloned as inactive.\n        this[$variantData],\n        clonedSet);\n\n    this[$materials].push(clonedMaterial);\n\n    return clonedMaterial;\n  }\n\n  createMaterialInstanceForVariant(\n      originalMaterialIndex: number, newMaterialName: string,\n      variantName: string, activateVariant: boolean = true): Material|null {\n    let variantMaterialInstance: Material|null = null;\n\n    for (const primitive of this[$primitivesList]) {\n      const variantData = this[$variantData].get(variantName);\n      // Skips the primitive if the variant already exists.\n      if (variantData != null && primitive.variantInfo.has(variantData.index)) {\n        continue;\n      }\n\n      // Skips the primitive if the source/original material does not exist.\n      if (primitive.getMaterial(originalMaterialIndex) == null) {\n        continue;\n      }\n\n      if (!this.hasVariant(variantName)) {\n        this.createVariant(variantName);\n      }\n\n      if (variantMaterialInstance == null) {\n        variantMaterialInstance =\n            this[$cloneMaterial](originalMaterialIndex, newMaterialName);\n      }\n      primitive.addVariant(variantMaterialInstance, variantName)\n    }\n\n    if (activateVariant && variantMaterialInstance != null) {\n      (variantMaterialInstance as Material)[$setActive](true);\n      this.materials[originalMaterialIndex][$setActive](false);\n      for (const primitive of this[$primitivesList]) {\n        primitive.enableVariant(variantName);\n      }\n    }\n\n    return variantMaterialInstance;\n  }\n\n  createVariant(variantName: string) {\n    if (!this[$variantData].has(variantName)) {\n      // Adds the name if it's not already in the list.\n      this[$variantData].set(\n          variantName,\n          {name: variantName, index: this[$variantData].size} as VariantData);\n    } else {\n      console.warn(`Variant '${variantName}'' already exists`);\n    }\n  }\n\n  hasVariant(variantName: string) {\n    return this[$variantData].has(variantName);\n  }\n\n  setMaterialToVariant(materialIndex: number, targetVariantName: string) {\n    if (this[$availableVariants]().find(name => name === targetVariantName) ==\n        null) {\n      console.warn(`Can't add material to '${\n          targetVariantName}', the variant does not exist.'`);\n      return;\n    }\n\n    if (materialIndex < 0 || materialIndex >= this.materials.length) {\n      console.error(`setMaterialToVariant(): materialIndex is out of bounds.`);\n      return;\n    }\n\n    for (const primitive of this[$primitivesList]) {\n      const material = primitive.getMaterial(materialIndex);\n      // Ensures the material exists on the primitive before setting it to a\n      // variant.\n      if (material != null) {\n        primitive.addVariant(material, targetVariantName);\n      }\n    }\n  }\n\n  updateVariantName(currentName: string, newName: string) {\n    const variantData = this[$variantData].get(currentName);\n    if (variantData == null) {\n      return;\n    }\n    variantData.name = newName;\n    this[$variantData].set(newName, variantData!);\n    this[$variantData].delete(currentName);\n  }\n\n  deleteVariant(variantName: string) {\n    const variant = this[$variantData].get(variantName);\n    if (variant == null) {\n      return;\n    }\n\n    for (const material of this.materials) {\n      if (material.hasVariant(variantName)) {\n        material[$variantSet].delete(variant.index);\n      }\n    }\n\n    for (const primitive of this[$primitivesList]) {\n      primitive.deleteVariant(variant.index);\n    }\n\n    this[$variantData].delete(variantName);\n  }\n}\n"]}