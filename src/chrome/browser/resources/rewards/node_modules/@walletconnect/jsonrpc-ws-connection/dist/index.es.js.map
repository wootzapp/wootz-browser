{"version":3,"file":"index.es.js","sources":["../src/utils.ts","../src/ws.ts"],"sourcesContent":["export const resolveWebSocketImplementation = () => {\n  if (typeof WebSocket !== \"undefined\") {\n    return WebSocket;\n  } else if (typeof global !== \"undefined\" && typeof global.WebSocket !== \"undefined\") {\n    return global.WebSocket;\n  } else if (typeof window !== \"undefined\" && typeof window.WebSocket !== \"undefined\") {\n    return window.WebSocket;\n  } else if (typeof self !== \"undefined\" && typeof self.WebSocket !== \"undefined\") {\n    return self.WebSocket;\n  }\n\n  return require(\"ws\");\n};\n\nexport const hasBuiltInWebSocket = () =>\n  typeof WebSocket !== \"undefined\" ||\n  (typeof global !== \"undefined\" && typeof global.WebSocket !== \"undefined\") ||\n  (typeof window !== \"undefined\" && typeof window.WebSocket !== \"undefined\") ||\n  (typeof self !== \"undefined\" && typeof self.WebSocket !== \"undefined\");\n\nexport const isBrowser = () => typeof window !== \"undefined\";\n\nexport const truncateQuery = (wssUrl: string) => wssUrl.split(\"?\")[0];\n","import { EventEmitter } from \"events\";\nimport { safeJsonParse, safeJsonStringify } from \"@walletconnect/safe-json\";\nimport {\n  formatJsonRpcError,\n  IJsonRpcConnection,\n  JsonRpcPayload,\n  isReactNative,\n  isWsUrl,\n  isLocalhostUrl,\n  parseConnectionError,\n} from \"@walletconnect/jsonrpc-utils\";\nimport { truncateQuery, resolveWebSocketImplementation, hasBuiltInWebSocket } from \"./utils\";\n\n// Source: https://nodejs.org/api/events.html#emittersetmaxlistenersn\nconst EVENT_EMITTER_MAX_LISTENERS_DEFAULT = 10;\n\nconst WS = resolveWebSocketImplementation();\n\nexport class WsConnection implements IJsonRpcConnection {\n  public events = new EventEmitter();\n\n  private socket: WebSocket | undefined;\n\n  private registering = false;\n\n  constructor(public url: string) {\n    if (!isWsUrl(url)) {\n      throw new Error(`Provided URL is not compatible with WebSocket connection: ${url}`);\n    }\n    this.url = url;\n  }\n\n  get connected(): boolean {\n    return typeof this.socket !== \"undefined\";\n  }\n\n  get connecting(): boolean {\n    return this.registering;\n  }\n\n  public on(event: string, listener: any): void {\n    this.events.on(event, listener);\n  }\n\n  public once(event: string, listener: any): void {\n    this.events.once(event, listener);\n  }\n\n  public off(event: string, listener: any): void {\n    this.events.off(event, listener);\n  }\n\n  public removeListener(event: string, listener: any): void {\n    this.events.removeListener(event, listener);\n  }\n\n  public async open(url: string = this.url): Promise<void> {\n    await this.register(url);\n  }\n\n  public async close(): Promise<void> {\n    return new Promise<void>((resolve, reject) => {\n      if (typeof this.socket === \"undefined\") {\n        reject(new Error(\"Connection already closed\"));\n        return;\n      }\n\n      this.socket.onclose = (event) => {\n        this.onClose(event);\n        resolve();\n      };\n\n      this.socket.close();\n    });\n  }\n\n  public async send(payload: JsonRpcPayload): Promise<void> {\n    if (typeof this.socket === \"undefined\") {\n      this.socket = await this.register();\n    }\n    try {\n      this.socket.send(safeJsonStringify(payload));\n    } catch (e) {\n      this.onError(payload.id, e as Error);\n    }\n  }\n\n  // ---------- Private ----------------------------------------------- //\n\n  private register(url = this.url): Promise<WebSocket> {\n    if (!isWsUrl(url)) {\n      throw new Error(`Provided URL is not compatible with WebSocket connection: ${url}`);\n    }\n    if (this.registering) {\n      const currentMaxListeners = this.events.getMaxListeners();\n      if (\n        this.events.listenerCount(\"register_error\") >= currentMaxListeners ||\n        this.events.listenerCount(\"open\") >= currentMaxListeners\n      ) {\n        this.events.setMaxListeners(currentMaxListeners + 1);\n      }\n      return new Promise((resolve, reject) => {\n        this.events.once(\"register_error\", (error) => {\n          this.resetMaxListeners();\n          reject(error);\n        });\n        this.events.once(\"open\", () => {\n          this.resetMaxListeners();\n          if (typeof this.socket === \"undefined\") {\n            return reject(new Error(\"WebSocket connection is missing or invalid\"));\n          }\n          resolve(this.socket);\n        });\n      });\n    }\n    this.url = url;\n    this.registering = true;\n\n    return new Promise((resolve, reject) => {\n      const origin = new URLSearchParams(url).get(\"origin\");\n      const opts = isReactNative()\n        ? { headers: { origin } }\n        : { rejectUnauthorized: !isLocalhostUrl(url) };\n      const socket: WebSocket = new WS(url, [], opts);\n      if (hasBuiltInWebSocket()) {\n        socket.onerror = (event: Event) => {\n          const errorEvent = event as ErrorEvent;\n          reject(this.emitError(errorEvent.error));\n        };\n      } else {\n        (socket as any).on(\"error\", (errorEvent: any) => {\n          reject(this.emitError(errorEvent));\n        });\n      }\n      socket.onopen = () => {\n        this.onOpen(socket);\n        resolve(socket);\n      };\n    });\n  }\n\n  private onOpen(socket: WebSocket) {\n    socket.onmessage = (event: MessageEvent) => this.onPayload(event);\n    socket.onclose = (event) => this.onClose(event);\n    this.socket = socket;\n    this.registering = false;\n    this.events.emit(\"open\");\n  }\n\n  private onClose(event: CloseEvent) {\n    this.socket = undefined;\n    this.registering = false;\n    this.events.emit(\"close\", event);\n  }\n\n  private onPayload(e: { data: any }) {\n    if (typeof e.data === \"undefined\") return;\n    const payload: JsonRpcPayload = typeof e.data === \"string\" ? safeJsonParse(e.data) : e.data;\n    this.events.emit(\"payload\", payload);\n  }\n\n  private onError(id: number, e: Error) {\n    const error = this.parseError(e);\n    const message = error.message || error.toString();\n    const payload = formatJsonRpcError(id, message);\n    this.events.emit(\"payload\", payload);\n  }\n\n  private parseError(e: Error, url = this.url) {\n    return parseConnectionError(e, truncateQuery(url), \"WS\");\n  }\n\n  private resetMaxListeners() {\n    if (this.events.getMaxListeners() > EVENT_EMITTER_MAX_LISTENERS_DEFAULT) {\n      this.events.setMaxListeners(EVENT_EMITTER_MAX_LISTENERS_DEFAULT);\n    }\n  }\n\n  private emitError(errorEvent: Error) {\n    const error = this.parseError(\n      new Error(\n        errorEvent?.message || `WebSocket connection failed for host: ${truncateQuery(this.url)}`,\n      ),\n    );\n    this.events.emit(\"register_error\", error);\n    return error;\n  }\n}\n\nexport default WsConnection;\n"],"names":["wssUrl","EVENT_EMITTER_MAX_LISTENERS_DEFAULT","WS","resolveWebSocketImplementation","url","EventEmitter","isWsUrl","event","listener","resolve","reject","payload","safeJsonStringify","e","currentMaxListeners","error","origin","opts","isReactNative","isLocalhostUrl","socket","hasBuiltInWebSocket","errorEvent","safeJsonParse","id","message","formatJsonRpcError","parseConnectionError","truncateQuery"],"mappings":"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"}